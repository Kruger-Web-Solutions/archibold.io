#########################
# archibold.io (C) 2016 #
#########################

if [ "$(whoami)" = "root" ]; then
  echo "
  Unable to install GNOME as root
"
  exit
fi

if [ "$DISABLE_WAYLAND" = "" ]; then
  echo "
  Would you like to disable Wayland ? [y/N]

Only if your drivers work best in legacy Xorg,
or you are installing on Virtual Box, type y
"
  read -n1 -s DISABLE_WAYLAND
fi

if [ "$USE_GNOME_SOFTWARE" = "" ]; then
  echo "
  Would you like to use GNOME Software ? [y/N]

  The wonderful pamac-aur would be used otherwise.
"
  read -n1 -s USE_GNOME_SOFTWARE
fi

if [ "$(which sudo 2> /dev/null)" = "" ]; then
  bash <(curl -s https://archibold.io/install/sudo)
fi

echo "please wait for the GPU setup ..."

source <(curl -s https://archibold.io/install/gpu)

echoWithHeader "
  Installing GNOME with GPU drivers:
  $GPU_DRIVERS
"

GNOME=""
for pkg in $(sudo pacman -Sg gnome); do
  if [ "${pkg}" != "gnome" ] && [ "${pkg}" != "gnome-software" ] && [ "${pkg}" != "gnome-boxes" ]; then
    GNOME="${GNOME} ${pkg}"
  fi
done

# TODO: figure out if alsa-utils and pulseaudio are needed at all
# sudo pacman -S --needed --noconfirm alsa-utils pulseaudio

sudo pacman -S --needed --noconfirm \
  flatpak \
  xf86-input-libinput xsel \
  cups system-config-printer simple-scan \
  bluez bluez-utils \
  gnome-tweaks chrome-gnome-shell $GNOME

if [ "$USE_GNOME_SOFTWARE" = "y" ] || [ "$USE_GNOME_SOFTWARE" = "Y" ]; then
  echoWithHeader "
  Installing GNOME Software
"
  sudo pacman -S --needed --noconfirm \
    gnome-software gnome-packagekit gnome-software-packagekit-plugin
else
  echoWithHeader "
  Installing pamac-aur
"
  if [ "$(which aur 2> /dev/null)" = "" ]; then
    source <(curl -s https://archibold.io/utils/aur)
  fi
  aur pamac-aur
fi

if [ "$DISABLE_WAYLAND" = "y" ] || [ "$DISABLE_WAYLAND" = "Y" ]; then
  sudo sed -ie 's/#WaylandEnable=false/WaylandEnable=false/' /etc/gdm/custom.conf
fi

sleep 2

echoWithHeader "
  Enabling NetworkManager and GDM
"

sudo systemctl enable NetworkManager
sudo systemctl enable gdm

echoWithHeader "
  Installing common fonts
"

bash <(curl -s https://archibold.io/install/fonts)

echoWithHeader "
  Installing common filesystem utilities (read/write)
"

bash <(curl -s https://archibold.io/install/fsutils)

# automatic date and time
if [ "$(which timedatectl 2> /dev/null)" != "" ]; then
  sudo timedatectl set-ntp 1
  timedatectl set-ntp 1
fi

echoWithHeader "
  Setting up some glorious GNOME feature
"

# switch on dark mode, it's absolutely worth it
sudo gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita-dark'
gsettings set org.gnome.desktop.interface gtk-theme 'Adwaita-dark'

# see min/max buttons on every widget
sudo gsettings set org.gnome.desktop.wm.preferences button-layout 'appmenu:minimize,maximize,close'
gsettings set org.gnome.desktop.wm.preferences button-layout 'appmenu:minimize,maximize,close'

# center new windows
sudo gsettings set org.gnome.mutter center-new-windows true
gsettings set org.gnome.mutter center-new-windows true

# enable location and automatic time zone
sudo gsettings set org.gnome.system.location enabled true
gsettings set org.gnome.system.location enabled true
sudo gsettings set org.gnome.desktop.datetime automatic-timezone true
gsettings set org.gnome.desktop.datetime automatic-timezone true

if [ "$(which pamac 2> /dev/null)" != "" ]; then
  # enable pamac icon
  gnome-extensions enable pamac-updates@manjaro.org
fi
