#!/usr/bin/env bash

# (c) 2018 Andrea Giammarchi - @WebReflection - (ISC)

if [ "$USER" != "root" ]; then
  echo "you need to be $(tput bold)root$(tput sgr0)";
  exit 1;
fi

cd /home/alarm

# install all dependencies and optimize
bash <(curl -s archibold.io/kiosk/dependencies)

# enable full kms driver and audio
echo "
dtoverlay=vc4-fkms-v3d
dtparam=audio=on
">>/boot/config.txt

if [ -f /boot/boot.txt ]; then
  # modify boot.scr to reserve cma memory and make the boot silent
  pacman -S --needed --noconfirm uboot-tools
  sed -i "s/rootwait/rootwait quiet loglevel=0 splash cma=128MB@64MB/" /boot/boot.txt
  # sed -i "s/rootwait/rootwait cma=128MB@64MB/" /boot/boot.txt
  mkimage -T script -C none -n "RPi3 VC4" -d /boot/boot.txt /boot/boot.scr
else
  # modify cmdline.txt mostly to make the boot silent (cma might be ignored)
  sed -i "s/rootwait/rootwait quiet loglevel=0 splash cma=128MB@64MB/" /boot/cmdline.txt
fi

# automatic login
mkdir -p /etc/systemd/system/getty@tty1.service.d
echo "[Service]
ExecStart=
ExecStart=-/usr/sbin/agetty -nia alarm %I
">/etc/systemd/system/getty@tty1.service.d/override.conf

# download a minimalistic full screen browser
# curl -L bit.ly/2HPq5Nq -o browse ... or ...
curl -L archibold.io/test/gjs/browser -o .browse
chmod a+x .browse
chown alarm:alarm .browse

# create www/index.html
mkdir -p www
echo '<!doctype html><h1>Web Pi Kiosk</h1><pre>'>www/index.html
ip addr>>www/index.html
echo '</pre>'>>www/index.html
chown -R alarm:alarm www

# setup the xinitrc
echo "# x11 configuration

# to change resolution *
# * WIDTHxHEIGTH must be compatible with your screen
# xrandr -s 1280x720

# if not working, try to add hdmi
# values in the /boot/config.txt
# https://www.raspberrypi.org/documentation/configuration/config-txt/video.md

# hdmi_group=1
# hdmi_mode=3
# hdmi_mode=4

# avoid sleep
xset s off -dpms

# unclutter the cursor then browse a generic page *
# * if you install nodejs bootstrap replace ./.browse ... with npm start
unclutter &
./.browse --fullscreen file:///home/alarm/www/index.html

# in case you'd like to see if it's hardware accelerated, try one of these
# ./.browse --bgcolor=0,0,0 --fullscreen https://threejs.org/examples/webgl_geometry_cube.html
# ./.browse --bgcolor=0,0,0 --fullscreen https://www.youtube.com/watch?v=IlVtF3dAyxs
">.xinitrc
chown alarm:alarm .xinitrc

# bootstrap xorg from .bashrc
echo '
# startx on login
[[ -z $DISPLAY && $XDG_VTNR -eq 1 ]] && exec startx > /dev/null 2>&1'>>.bashrc
chown alarm:alarm .bashrc

# avoid initial message
touch .hushlogin
chown alarm:alarm .hushlogin

reboot
