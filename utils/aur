#!/usr/bin/env sh

#########################
# (c) archibold.io 2019 #
#########################

aur() {
  local pkg="${1}"
  local preserve="${2}"
  if [ "${pkg}" = "--preserve" ]; then
    pkg="${preserve}"
    preserve="--preserve"
  fi
  if [ "${pkg}" = "" ]; then
    echo ""
    echo "The $(tput bold)aur$(tput sgr0) utility, from https://archibold.io"
    echo "$(tput dim)A minimalistic AUR installer alternative.$(tput sgr0)"
    echo ""
    echo "  aur pakku"
    echo "  aur --preserve wpewebkit"
    echo ""
    echo "$(tput dim)Use $(tput sgr0)--preserve$(tput dim) to avoid removing the folder once built,"
    echo "which is specially useful when things don't go as expected.$(tput sgr0)"
    echo ""
  elif [ "$USER" = "root" ]; then
    echo ""
    echo "You $(tput bold)cannot be root$(tput sgr0) to run $(tput bold)aur$(tput sgr0)"
    echo ""
  else
    if [ ! -f ~/.archibold-aur ]; then
      date > ~/.archibold-aur
      echo "Installing $(tput bold)base-devel$(tput sgr0) and $(tput bold)git$(tput sgr0)"
      su -c 'pacman -S --needed --noconfirm base-devel git'
    fi
    rm -rf ~/tmp-${pkg}
    mkdir -p ~/tmp-${pkg}
    cd ~/tmp-${pkg}
    git clone https://aur.archlinux.org/${pkg}.git
    cd ${pkg}
    makepkg -Asfc --needed --noconfirm
    echo ""
    if [ "$(ls ${pkg}*.pkg.tar.xz 2> /dev/null)" != "" ]; then
      echo "$(tput bold)Created$(tput sgr0): ~/tmp-${pkg}/${pkg}/$(ls ${pkg}*.pkg.tar.xz)"
      sleep 1
      su -c "pacman -U --noconfirm $(ls ${pkg}*.pkg.tar.xz)"
    else
      echo "$(tput bold)Error$(tput sgr0): ${pkg}*.tar.xz not found"
    fi
    if [ "${preserve}" != "--preserve" ]; then
      echo "cleaning up"
      rm -rf ~/tmp-${pkg}
    fi
    echo ""
  fi
}

aur "${1}" "${2}"
