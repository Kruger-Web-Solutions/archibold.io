#!/usr/bin/env sh

#########################
# (c) archibold.io 2019 #
#########################

aur() {
  local pkg=""
  local preserve=""
  local skippgp=""
  if [ "${3}" = "--no-pgp" ] || [ "${2}" = "--no-pgp" ] || [ "${1}" = "--no-pgp" ]; then
    skippgp="--skippgpcheck"
  fi
  if [ "${3}" = "--preserve" ] || [ "${2}" = "--preserve" ] || [ "${1}" = "--preserve" ]; then
    preserve="--preserve"
  fi
  pkg="${1}"
  if [ "${pkg}" = "--no-pgp" ] || [ "${pkg}" = "--preserve" ]; then
    pkg="${2}"
    if [ "${pkg}" = "--no-pgp" ] || [ "${pkg}" = "--preserve" ]; then
      pkg="${3}"
    fi
  fi
  if [ "${pkg}" = "" ]; then
    echo ""
    echo "The $(tput bold)aur$(tput sgr0) utility, from https://archibold.io"
    echo "$(tput dim)A minimalistic AUR installer alternative.$(tput sgr0)"
    echo ""
    echo "  aur pakku"
    echo "  aur --preserve wpewebkit"
    echo "  aur --no-pgp expressvpn"
    echo ""
    echo "$(tput dim)Use $(tput sgr0)--preserve$(tput dim) to avoid removing the folder once built,"
    echo "which is specially useful when things don't go as expected.$(tput sgr0)"
    echo ""
    echo "$(tput dim)Use $(tput sgr0)--no-pgp$(tput dim) to ignore PGP keys $(tput sgr0)at your own risk"
    echo ""
    echo "$(tput dim)Use $(tput sgr0)AUR_NO_SUDO=1$(tput dim) to force-use su instead$(tput sgr0)"
    echo ""
  elif [ "$USER" = "root" ]; then
    echo ""
    echo "You $(tput bold)cannot be root$(tput sgr0) to run $(tput bold)aur$(tput sgr0)"
    echo ""
  else
    if [ ! -f ~/.archibold-aur ]; then
      date > ~/.archibold-aur
      echo "Installing $(tput bold)base-devel$(tput sgr0) and $(tput bold)git$(tput sgr0)"
      if [ "$AUR_NO_SUDO" != "" ] || [ "$(which sudo 2> /dev/null)" = "" ]; then
        su -c 'pacman -S --needed --noconfirm base-devel git'
      else
        sudo pacman -S --needed --noconfirm base-devel git
      fi
    fi
    rm -rf ~/tmp-${pkg}
    mkdir -p ~/tmp-${pkg}
    cd ~/tmp-${pkg}
    git clone https://aur.archlinux.org/${pkg}.git
    cd ${pkg}
    makepkg -Asfc --needed --noconfirm ${skippgp}
    echo ""
    if [ "$?" = "0" ] && [ "$(ls ${pkg}*.pkg.tar.xz 2> /dev/null)" != "" ]; then
      echo "$(tput bold)Created$(tput sgr0): ~/tmp-${pkg}/${pkg}/$(ls ${pkg}*.pkg.tar.xz)"
      sleep 1
      if [ "$AUR_NO_SUDO" != "" ] || [ "$(which sudo 2> /dev/null)" = "" ]; then
        su -c "pacman -U --noconfirm $(ls ${pkg}*.pkg.tar.xz)"
      else
        sudo pacman -U --noconfirm $(ls ${pkg}*.pkg.tar.xz)
      fi
    else
      echo "$(tput bold)Error$(tput sgr0) $?: ${pkg}*.tar.xz not found"
    fi
    if [ "${preserve}" != "--preserve" ]; then
      echo "cleaning up"
      rm -rf ~/tmp-${pkg}
    fi
    echo ""
  fi
}

if [ "$AUR_NO_SUDO" = "" ] && [ "$(which sudo 2> /dev/null)" != "" ]; then
  echo "Checking $(tput bold)sudo$(tput sgr0) privileges"
  sudo ls > /dev/null
fi

aur "${1}" "${2}" "${3}"
